<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RSA加密工具 - 飞书回调</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
</head>
<body>
    <div id="result"></div>

    <script>
        // 从URL获取参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // RSA加密函数
        function encryptContent(pbkey, content) {
            if (!pbkey || !content) return "";
            const encrypt = new JSEncrypt();
            encrypt.setPublicKey(pbkey);
            return encrypt.encrypt(content) || "";
        }

        // 处理特殊字符
        function dealEncryptContent(content) {
            if (!content) return content;
            const specialCharMap = [
                { original: '+', encoded: '%2B' },
                { original: ' ', encoded: '%20' },
                { original: '/', encoded: '%2F' },
                { original: '?', encoded: '%3F' },
                { original: '&', encoded: '%26' },
                { original: '=', encoded: '%3D' },
                { original: '#', encoded: '%23' }
            ];
            
            let processed = content;
            specialCharMap.forEach(mapping => {
                processed = processed.replace(new RegExp('\\' + mapping.original, 'g'), mapping.encoded);
            });
            return processed;
        }

        // 发送数据到飞书
        function sendToFeishu(encryptedData) {
            const feishuUrl = 'https://open.feishu.cn/anycross/trigger/callback/MDM3YmNiMDY3ZGYxYzFlZmYyNmRkN2Q4Njk2MzRmYWRi';
            
            fetch(feishuUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    encrypted_data: encryptedData,
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('result').textContent = '数据已成功发送到飞书: ' + JSON.stringify(data);
            })
            .catch(error => {
                document.getElementById('result').textContent = '发送到飞书失败: ' + error.message;
            });
        }

        // 主执行逻辑
        function main() {
            const pbkey = getQueryParam('pbkey');
            const content = getQueryParam('content');
            
            if (!pbkey || !content) {
                document.getElementById('result').textContent = '请提供pbkey和content参数';
                return;
            }
            
            try {
                // 加密内容
                const encrypted = encryptContent(pbkey, content);
                if (!encrypted) {
                    document.getElementById('result').textContent = '加密失败，请检查公钥格式';
                    return;
                }
                
                // 处理特殊字符
                const processed = dealEncryptContent(encrypted);
                
                // 显示加密结果
                document.getElementById('result').textContent = '加密结果: ' + processed;
                
                // 发送到飞书
                sendToFeishu(processed);
                
            } catch (e) {
                document.getElementById('result').textContent = '加密过程中出错: ' + e.message;
            }
        }

        // 页面加载后执行
        window.onload = main;
    </script>
</body>
</html>
